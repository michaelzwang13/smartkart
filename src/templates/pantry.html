<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Pantry - Preppr</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* CSS Variables matching theme */
    :root {
      --primary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --secondary-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      --accent-gradient: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #34d399;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --text-white: #ffffff;
      
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      
      --border-light: #e5e7eb;
      --border-medium: #d1d5db;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      
      --font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: var(--font-family);
      color: var(--text-primary);
      line-height: 1.6;
      background: var(--bg-secondary);
      overflow-x: hidden;
      padding-top: 80px;
    }
    
    /* Header and Navigation */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }
    
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 80px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      text-decoration: none;
      transition: transform 0.3s ease;
    }
    
    .logo:hover {
      transform: scale(1.05);
    }
    
    .nav-links {
      display: flex;
      list-style: none;
      gap: var(--spacing-lg);
      align-items: center;
    }
    
    .nav-link {
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      position: relative;
      transition: color 0.3s ease;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
    }
    
    .nav-link:hover {
      color: var(--primary-color);
      background: rgba(102, 126, 234, 0.1);
    }
    
    .nav-link.logout {
      color: var(--error-color);
    }
    
    .nav-link.logout:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Dropdown Styles */
    .nav-dropdown {
      position: relative;
    }

    .dropdown-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .dropdown-arrow {
      transition: transform 0.3s ease;
    }

    .nav-dropdown:hover .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      min-width: 160px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
      list-style: none;
      padding: var(--spacing-xs) 0;
      margin: 0;
    }

    .dropdown-menu::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 8px;
      height: 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-bottom: none;
      border-right: none;
      transform: translateX(-50%) rotate(45deg);
    }

    .nav-dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .dropdown-link {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      background: none;
      font-size: 0.9rem;
    }

    .dropdown-link:hover {
      background: var(--bg-secondary);
      color: var(--primary-color);
    }

    .dropdown-link.logout {
      color: var(--error-color);
    }

    .dropdown-link.logout:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
    }

    .dropdown-link i {
      font-size: 0.85rem;
      width: 14px;
      text-align: center;
    }

    /* Add subtle separators in dropdown */
    .dropdown-menu li:not(:last-child) {
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dropdown-menu li:last-child .dropdown-link {
      border-bottom: none;
    }
    
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .pantry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .header-actions {
      display: flex;
      align-items: center;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-family: var(--font-family);
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .pantry-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9em;
      color: var(--text-primary);
    }

    .filter-group select {
      padding: 8px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .pantry-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-primary);
      padding: 20px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      text-align: center;
      box-shadow: var(--shadow-sm);
    }

    .stat-card.expired {
      border-left: 4px solid var(--error-color);
    }

    .stat-card.warning {
      border-left: 4px solid var(--warning-color);
    }

    .stat-card h3 {
      margin: 0 0 5px 0;
      font-size: 2em;
      color: var(--text-primary);
    }

    .stat-card p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    .pantry-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .category-section {
      margin-bottom: var(--spacing-2xl);
    }
    
    .category-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--border-light);
    }
    
    .category-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-white);
      font-size: 1.2rem;
    }
    
    .category-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .category-count {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .pantry-item {
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 15px;
      position: relative;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .pantry-item:hover {
      box-shadow: var(--shadow-md);
    }

    .pantry-item.expired {
      border-left: 4px solid var(--error-color);
    }

    .pantry-item.expiring-soon {
      border-left: 4px solid var(--warning-color);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .item-name {
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .item-actions {
      display: flex;
      gap: 5px;
    }

    .item-actions button {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 2px 5px;
      border-radius: var(--radius-sm);
      transition: all 0.3s ease;
    }

    .item-actions button:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .item-details {
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    .item-details p {
      margin: 5px 0;
    }

    .expiry-status {
      font-weight: 600;
    }

    .expiry-status.expired {
      color: var(--error-color);
    }

    .expiry-status.expiring-soon {
      color: var(--warning-color);
    }

    .expiry-status.fresh {
      color: var(--success-color);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 20px 0;
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 15px;
      padding: 0 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      padding: 0 20px;
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9em;
      color: var(--text-primary);
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      box-sizing: border-box;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-family);
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      background: var(--bg-primary);
    }

    .ai-predict {
      display: flex !important;
      align-items: center;
      margin-top: 8px;
      font-weight: normal !important;
    }

    .ai-predict input {
      width: auto !important;
      margin-right: 8px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 20px;
      border-top: 1px solid var(--border-light);
      margin-top: 20px;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border-medium);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-family: var(--font-family);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
      /* Mobile dropdown adjustments */
      .dropdown-menu {
        position: fixed;
        top: 80px;
        left: var(--spacing-md);
        right: var(--spacing-md);
        min-width: calc(100% - 2 * var(--spacing-md));
        border-radius: var(--radius-xl);
        box-shadow: 
          0 20px 40px rgba(0, 0, 0, 0.15),
          0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-20px) scale(0.95);
        backdrop-filter: blur(20px);
      }
      .dropdown-menu::before {
        display: none;
      }
      .nav-dropdown:hover .dropdown-menu,
      .nav-dropdown.active .dropdown-menu {
        transform: translateY(0) scale(1);
        opacity: 1;
        visibility: visible;
      }
      
      .nav-links {
        display: none;
      }
      
      .pantry-filters {
        grid-template-columns: 1fr;
      }
      
      .pantry-grid {
        grid-template-columns: 1fr;
      }
      
      .category-grid {
        grid-template-columns: 1fr;
      }
      
      .category-header {
        flex-wrap: wrap;
        gap: var(--spacing-sm);
      }
      
      .category-title {
        font-size: 1.25rem;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="nav-container">
      <a href="{{ url_for('shopping.home') }}" class="logo">
        <img src="{{ url_for('static', filename='images/preppr-logo.png') }}" alt="Preppr Logo" style="width: 40px; height: 40px; border-radius: var(--radius-lg);">
        Preppr
      </a>
      
      <nav>
        <ul class="nav-links">
          <li class="nav-dropdown">
            <a href="#" class="nav-link dropdown-toggle">
              <i class="fas fa-shopping-cart" style="margin-right: 6px; font-size: 0.85em;"></i>Shopping
              <i class="fas fa-chevron-down dropdown-arrow" style="margin-left: 6px; font-size: 0.7em;"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a href="{{ url_for('shopping.shopping_trip') }}" class="dropdown-link">
                <i class="fas fa-cart-plus"></i>New Trip
              </a></li>
              <li><a href="{{ url_for('shopping.shopping_lists') }}" class="dropdown-link">
                <i class="fas fa-list-ul"></i>Lists
              </a></li>
            </ul>
          </li>
          <li><a href="{{ url_for('shopping.budget') }}" class="nav-link">
            <i class="fas fa-chart-line" style="margin-right: 6px; font-size: 0.85em;"></i>Budget & Analytics
          </a></li>
          <li class="nav-dropdown">
            <a href="#" class="nav-link dropdown-toggle" style="color: var(--primary-color);">
              <i class="fas fa-utensils" style="margin-right: 6px; font-size: 0.85em;"></i>Kitchen
              <i class="fas fa-chevron-down dropdown-arrow" style="margin-left: 6px; font-size: 0.7em;"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a href="{{ url_for('shopping.pantry') }}" class="dropdown-link" style="color: var(--primary-color);">
                <i class="fas fa-warehouse"></i>My Pantry
              </a></li>
              <li><a href="{{ url_for('shopping.meal_plans') }}" class="dropdown-link">
                <i class="fas fa-calendar-alt"></i>Meal Plans
              </a></li>
            </ul>
          </li>
          <li class="nav-dropdown">
            <a href="#" class="nav-link dropdown-toggle">
              <i class="fas fa-user" style="margin-right: 6px; font-size: 0.85em;"></i>Account
              <i class="fas fa-chevron-down dropdown-arrow" style="margin-left: 6px; font-size: 0.7em;"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a href="{{ url_for('auth.logout') }}" class="dropdown-link logout">
                <i class="fas fa-sign-out-alt"></i>Logout
              </a></li>
            </ul>
          </li>
        </ul>
        
        <button class="mobile-menu-btn" aria-label="Toggle mobile menu">
          <i class="fas fa-bars"></i>
        </button>
      </nav>
    </div>
  </header>

  <div class="container">
    <div class="pantry-header">
        <h2>My Pantry</h2>
        <div class="header-actions">
            <button id="deleteExpiredBtn" class="btn-secondary" style="margin-right: 10px; font-size: 0.9rem; padding: var(--spacing-sm) var(--spacing-md);"><i class="fas fa-trash"></i> Delete All Expired</button>
            <button id="addItemBtn" class="btn-primary" style="font-size: 0.9rem; padding: var(--spacing-sm) var(--spacing-md);">+ Add Item Manually</button>
        </div>
    </div>
    
    <div class="pantry-filters">
        <div class="filter-group">
            <label>Search Items:</label>
            <input type="text" id="searchFilter" placeholder="Search by item name...">
        </div>
        
        <div class="filter-group">
            <label>Storage Location:</label>
            <select id="storageFilter">
                <option value="">All Locations</option>
                <option value="pantry">Pantry</option>
                <option value="fridge">Refrigerator</option>
                <option value="freezer">Freezer</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Category:</label>
            <select id="categoryFilter">
                <option value="">All Categories</option>
                <option value="Produce">Produce</option>
                <option value="Meat">Meat</option>
                <option value="Dairy">Dairy</option>
                <option value="Grains">Grains</option>
                <option value="Canned Goods">Canned Goods</option>
                <option value="Frozen Foods">Frozen Foods</option>
                <option value="Beverages">Beverages</option>
                <option value="Snacks">Snacks</option>
                <option value="Condiments">Condiments</option>
                <option value="Spices">Spices</option>
                <option value="Bread">Bread</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Expiration Status:</label>
            <select id="expiryFilter">
                <option value="">All Items</option>
                <option value="expired">Expired</option>
                <option value="expiring_soon">Expiring Soon (3 days)</option>
                <option value="fresh">Fresh</option>
            </select>
        </div>
    </div>
    
    <div class="pantry-stats">
        <div class="stat-card">
            <h3 id="totalItems">0</h3>
            <p>Total Items</p>
        </div>
        <div class="stat-card expired">
            <h3 id="expiredItems">0</h3>
            <p>Expired</p>
        </div>
        <div class="stat-card warning">
            <h3 id="expiringSoonItems">0</h3>
            <p>Expiring Soon</p>
        </div>
    </div>
    
    <div id="pantryItems" class="pantry-grid">
        <!-- Items will be loaded here -->
    </div>
    
    <div id="emptyState" class="empty-state" style="display: none;">
        <h3>Your pantry is empty</h3>
        <p>Start by completing a shopping trip or adding items manually.</p>
        <button id="addFirstItemBtn" class="btn-primary">Add Your First Item</button>
    </div>
  </div>

  <!-- Add Item Modal -->
  <div id="addItemModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Item to Pantry</h3>
            <button class="close-btn">&times;</button>
        </div>
        
        <form id="addItemForm">
            <div class="form-group">
                <label>Item Name:</label>
                <input type="text" name="item_name" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" step="0.01" name="quantity" min="0.01" value="1" required>
                </div>
                
                <div class="form-group">
                    <label>Unit:</label>
                    <select name="unit" id="unitSelect">
                        <option value="pcs">pieces</option>
                        <option value="g">grams</option>
                        <option value="kg">kilograms</option>
                        <option value="ml">milliliters</option>
                        <option value="l">liters</option>
                        <option value="oz">ounces</option>
                        <option value="lbs">pounds</option>
                        <option value="custom">Custom...</option>
                    </select>
                    <input type="text" name="custom_unit" id="customUnitInput" placeholder="Enter custom unit" style="display: none; margin-top: 8px;">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Storage:</label>
                    <select name="storage_type">
                        <option value="pantry">Pantry</option>
                        <option value="fridge">Refrigerator</option>
                        <option value="freezer">Freezer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Category:</label>
                    <select name="category">
                        <option value="Other">Other</option>
                        <option value="Produce">Produce</option>
                        <option value="Meat">Meat</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Grains">Grains</option>
                        <option value="Canned Goods">Canned Goods</option>
                        <option value="Frozen Foods">Frozen Foods</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Condiments">Condiments</option>
                        <option value="Spices">Spices</option>
                        <option value="Bread">Bread</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Expiration Date (optional):</label>
                <input type="date" name="expiration_date">
                <label class="ai-predict">
                    <input type="checkbox" name="ai_predict_expiry">
                    Use AI prediction if no date provided
                </label>
            </div>
            
            <div class="form-group">
                <label>Notes (optional):</label>
                <textarea name="notes" rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-secondary close-btn">Cancel</button>
                <button type="submit" class="btn-primary">Add Item</button>
            </div>
        </form>
    </div>
  </div>

  <!-- Edit Item Modal -->
  <div id="editItemModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Pantry Item</h3>
            <button class="close-btn">&times;</button>
        </div>
        
        <form id="editItemForm">
            <input type="hidden" id="editItemId" name="item_id">
            
            <div class="form-group">
                <label>Item Name:</label>
                <input type="text" id="editItemName" name="item_name" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" step="0.01" id="editQuantity" name="quantity" min="0.01" required>
                </div>
                
                <div class="form-group">
                    <label>Unit:</label>
                    <select id="editUnit" name="unit">
                        <option value="pcs">pieces</option>
                        <option value="g">grams</option>
                        <option value="kg">kilograms</option>
                        <option value="ml">milliliters</option>
                        <option value="l">liters</option>
                        <option value="oz">ounces</option>
                        <option value="lbs">pounds</option>
                        <option value="custom">Custom...</option>
                    </select>
                    <input type="text" name="custom_unit" id="editCustomUnitInput" placeholder="Enter custom unit" style="display: none; margin-top: 8px;">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Storage:</label>
                    <select id="editStorageType" name="storage_type">
                        <option value="pantry">Pantry</option>
                        <option value="fridge">Refrigerator</option>
                        <option value="freezer">Freezer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Category:</label>
                    <select id="editCategory" name="category">
                        <option value="Other">Other</option>
                        <option value="Produce">Produce</option>
                        <option value="Meat">Meat</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Grains">Grains</option>
                        <option value="Canned Goods">Canned Goods</option>
                        <option value="Frozen Foods">Frozen Foods</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Condiments">Condiments</option>
                        <option value="Spices">Spices</option>
                        <option value="Bread">Bread</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Expiration Date (optional):</label>
                <input type="date" id="editExpirationDate" name="expiration_date">
                <label class="ai-predict">
                    <input type="checkbox" id="editAiPredict" name="ai_predict_expiry">
                    Use AI prediction if no date provided
                </label>
            </div>
            
            <div class="form-group">
                <label>Notes (optional):</label>
                <textarea id="editNotes" name="notes" rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-secondary close-btn">Cancel</button>
                <button type="submit" class="btn-primary">Update Item</button>
            </div>
        </form>
    </div>
  </div>

<script>
// Initialize dropdown functionality
function initializeDropdowns() {
  // Get all dropdown toggles
  const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
  
  dropdownToggles.forEach(toggle => {
    // Handle mobile click behavior
    if (window.innerWidth <= 768) {
      toggle.addEventListener('click', function(e) {
        e.preventDefault();
        const dropdown = this.closest('.nav-dropdown');
        const menu = dropdown.querySelector('.dropdown-menu');
        
        // Close other dropdowns
        document.querySelectorAll('.nav-dropdown').forEach(otherDropdown => {
          if (otherDropdown !== dropdown) {
            otherDropdown.classList.remove('active');
          }
        });
        
        // Toggle current dropdown
        dropdown.classList.toggle('active');
      });
    }
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.nav-dropdown')) {
      document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
        dropdown.classList.remove('active');
      });
    }
  });
}

// Handle window resize for dropdown behavior
function handleDropdownResize() {
  window.addEventListener('resize', function() {
    // Remove active class when switching to desktop
    if (window.innerWidth > 768) {
      document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
        dropdown.classList.remove('active');
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
    initializeDropdowns();
    handleDropdownResize();
    
    const addItemBtn = document.getElementById('addItemBtn');
    const addFirstItemBtn = document.getElementById('addFirstItemBtn');
    const deleteExpiredBtn = document.getElementById('deleteExpiredBtn');
    const addItemModal = document.getElementById('addItemModal');
    const addItemForm = document.getElementById('addItemForm');
    const editItemModal = document.getElementById('editItemModal');
    const editItemForm = document.getElementById('editItemForm');
    const pantryItems = document.getElementById('pantryItems');
    const emptyState = document.getElementById('emptyState');
    
    // Modal controls
    addItemBtn.addEventListener('click', () => addItemModal.style.display = 'flex');
    addFirstItemBtn.addEventListener('click', () => addItemModal.style.display = 'flex');
    
    // Delete expired items
    deleteExpiredBtn.addEventListener('click', deleteAllExpiredItems);
    
    // Handle custom unit functionality for Add Item modal
    const unitSelect = document.getElementById('unitSelect');
    const customUnitInput = document.getElementById('customUnitInput');
    
    unitSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customUnitInput.style.display = 'block';
            customUnitInput.required = true;
        } else {
            customUnitInput.style.display = 'none';
            customUnitInput.required = false;
            customUnitInput.value = '';
        }
    });
    
    // Handle custom unit functionality for Edit Item modal
    const editUnitSelect = document.getElementById('editUnit');
    const editCustomUnitInput = document.getElementById('editCustomUnitInput');
    
    editUnitSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            editCustomUnitInput.style.display = 'block';
            editCustomUnitInput.required = true;
        } else {
            editCustomUnitInput.style.display = 'none';
            editCustomUnitInput.required = false;
            editCustomUnitInput.value = '';
        }
    });
    
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            addItemModal.style.display = 'none';
            editItemModal.style.display = 'none';
            // Reset custom unit inputs when closing modals
            resetCustomUnitInputs();
        });
    });
    
    // Function to reset custom unit inputs
    function resetCustomUnitInputs() {
        // Reset Add Item modal
        unitSelect.value = 'pcs';
        customUnitInput.style.display = 'none';
        customUnitInput.required = false;
        customUnitInput.value = '';
        
        // Reset Edit Item modal
        editUnitSelect.value = 'pcs';
        editCustomUnitInput.style.display = 'none';
        editCustomUnitInput.required = false;
        editCustomUnitInput.value = '';
    }
    
    // Load pantry items on page load
    loadPantryItems();
    
    // Filter event listeners
    document.getElementById('searchFilter').addEventListener('input', loadPantryItems);
    document.getElementById('storageFilter').addEventListener('change', loadPantryItems);
    document.getElementById('categoryFilter').addEventListener('change', loadPantryItems);
    document.getElementById('expiryFilter').addEventListener('change', loadPantryItems);
    
    // Add item form submission
    addItemForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(addItemForm);
        const unitValue = formData.get('unit');
        const finalUnit = unitValue === 'custom' ? formData.get('custom_unit') : unitValue;
        
        const itemData = {
            item_name: formData.get('item_name'),
            quantity: parseFloat(formData.get('quantity')),
            unit: finalUnit,
            storage_type: formData.get('storage_type'),
            category: formData.get('category'),
            expiration_date: formData.get('expiration_date') || null,
            ai_predict_expiry: formData.get('ai_predict_expiry') === 'on',
            notes: formData.get('notes') || null
        };
        
        try {
            const response = await fetch('/api/pantry/items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(itemData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                addItemModal.style.display = 'none';
                addItemForm.reset();
                resetCustomUnitInputs();
                loadPantryItems();
            } else {
                alert('Error adding item: ' + result.message);
            }
        } catch (error) {
            console.error('Add item error:', error);
            alert('Error adding item. Please try again.');
        }
    });
    
    // Edit item form submission
    editItemForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(editItemForm);
        const itemId = formData.get('item_id');
        const unitValue = formData.get('unit');
        const finalUnit = unitValue === 'custom' ? formData.get('custom_unit') : unitValue;
        
        const itemData = {
            item_name: formData.get('item_name'),
            quantity: parseFloat(formData.get('quantity')),
            unit: finalUnit,
            storage_type: formData.get('storage_type'),
            category: formData.get('category'),
            expiration_date: formData.get('expiration_date') || null,
            ai_predict_expiry: formData.get('ai_predict_expiry') === 'on',
            notes: formData.get('notes') || null
        };
        
        try {
            const response = await fetch(`/api/pantry/items/${itemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(itemData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                editItemModal.style.display = 'none';
                editItemForm.reset();
                resetCustomUnitInputs();
                loadPantryItems();
            } else {
                alert('Error updating item: ' + result.message);
            }
        } catch (error) {
            console.error('Edit item error:', error);
            alert('Error updating item. Please try again.');
        }
    });
    
    async function loadPantryItems() {
        try {
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase().trim();
            const storageFilter = document.getElementById('storageFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const expiryFilter = document.getElementById('expiryFilter').value;
            
            const params = new URLSearchParams();
            if (storageFilter) params.append('storage_type', storageFilter);
            if (categoryFilter) params.append('category', categoryFilter);
            if (expiryFilter) params.append('expiry_status', expiryFilter);
            
            const response = await fetch(`/api/pantry/items?${params}`);
            const result = await response.json();
            
            if (result.success) {
                let filteredItems = result.items;
                
                // Apply client-side search filter
                if (searchFilter) {
                    filteredItems = result.items.filter(item => 
                        item.item_name.toLowerCase().includes(searchFilter)
                    );
                }
                
                displayPantryItems(filteredItems);
                updateStats(filteredItems);
            } else {
                console.error('Error loading pantry items:', result.message);
            }
        } catch (error) {
            console.error('Load items error:', error);
        }
    }
    
    function displayPantryItems(items) {
        if (items.length === 0) {
            pantryItems.style.display = 'none';
            emptyState.style.display = 'block';
            
            const searchFilter = document.getElementById('searchFilter').value.trim();
            const emptyStateElement = document.getElementById('emptyState');
            
            if (searchFilter) {
                emptyStateElement.innerHTML = `
                    <h3>No items found</h3>
                    <p>No pantry items match your search for "${searchFilter}". Try a different search term.</p>
                `;
            } else {
                emptyStateElement.innerHTML = `
                    <h3>Your pantry is empty</h3>
                    <p>Start by completing a shopping trip or adding items manually.</p>
                    <button id="addFirstItemBtn" class="btn-primary">Add Your First Item</button>
                `;
                // Re-add event listener for the new button
                document.getElementById('addFirstItemBtn').addEventListener('click', () => {
                    document.getElementById('addItemModal').style.display = 'flex';
                });
            }
            return;
        }
        
        pantryItems.style.display = 'block';
        emptyState.style.display = 'none';
        
        const searchFilter = document.getElementById('searchFilter').value.trim();
        const storageFilter = document.getElementById('storageFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        
        // If filtering by specific category, storage, or search, use simple grid layout
        if (categoryFilter || storageFilter || searchFilter) {
            pantryItems.innerHTML = `<div class="pantry-grid">${items.map(item => createItemHTML(item)).join('')}</div>`;
            return;
        }
        
        // Group items by category for "All Locations" view
        const groupedItems = groupItemsByCategory(items);
        pantryItems.innerHTML = createCategorizedHTML(groupedItems);
    }
    
    function groupItemsByCategory(items) {
        const groups = {};
        
        items.forEach(item => {
            const category = item.category || 'Other';
            if (!groups[category]) {
                groups[category] = [];
            }
            groups[category].push(item);
        });
        
        // Sort categories alphabetically, but put 'Other' at the end
        const sortedCategories = Object.keys(groups).sort((a, b) => {
            if (a === 'Other') return 1;
            if (b === 'Other') return -1;
            return a.localeCompare(b);
        });
        
        const sortedGroups = {};
        sortedCategories.forEach(category => {
            sortedGroups[category] = groups[category];
        });
        
        return sortedGroups;
    }
    
    function createCategorizedHTML(groupedItems) {
        const categoryIcons = {
            'Produce': { icon: 'fas fa-apple-alt', color: 'var(--success-gradient)' },
            'Meat': { icon: 'fas fa-drumstick-bite', color: 'var(--error-gradient)' },
            'Dairy': { icon: 'fas fa-cheese', color: 'var(--warning-gradient)' },
            'Grains': { icon: 'fas fa-wheat', color: 'var(--secondary-gradient)' },
            'Canned Goods': { icon: 'fas fa-can-food', color: 'var(--accent-gradient)' },
            'Frozen Foods': { icon: 'fas fa-snowflake', color: 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)' },
            'Beverages': { icon: 'fas fa-glass-water', color: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)' },
            'Snacks': { icon: 'fas fa-cookie-bite', color: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)' },
            'Condiments': { icon: 'fas fa-pepper-hot', color: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)' },
            'Spices': { icon: 'fas fa-mortar-pestle', color: 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)' },
            'Bread': { icon: 'fas fa-bread-slice', color: 'linear-gradient(135deg, #92400e 0%, #78350f 100%)' },
            'Other': { icon: 'fas fa-box', color: 'var(--text-secondary)' }
        };
        
        let html = '';
        
        Object.entries(groupedItems).forEach(([category, items]) => {
            const categoryInfo = categoryIcons[category] || categoryIcons['Other'];
            const expiredCount = items.filter(item => {
                const status = getExpiryStatus(item.expiration_date);
                return status.status === 'expired';
            }).length;
            const expiringSoonCount = items.filter(item => {
                const status = getExpiryStatus(item.expiration_date);
                return status.status === 'expiring_soon';
            }).length;
            
            html += `
                <div class="category-section">
                    <div class="category-header">
                        <div class="category-icon" style="background: ${categoryInfo.color};">
                            <i class="${categoryInfo.icon}"></i>
                        </div>
                        <h3 class="category-title">${category}</h3>
                        <div class="category-count">${items.length} items</div>
                        ${expiredCount > 0 ? `<div class="category-count" style="background: var(--error-color); color: white;">${expiredCount} expired</div>` : ''}
                        ${expiringSoonCount > 0 ? `<div class="category-count" style="background: var(--warning-color); color: white;">${expiringSoonCount} expiring soon</div>` : ''}
                    </div>
                    <div class="category-grid">
                        ${items.map(item => createItemHTML(item)).join('')}
                    </div>
                </div>
            `;
        });
        
        return html;
    }
    
    function createItemHTML(item) {
        const expiryStatus = getExpiryStatus(item.expiration_date);
        const expiryClass = expiryStatus.status === 'expired' ? 'expired' : 
                           expiryStatus.status === 'expiring_soon' ? 'expiring-soon' : '';
        
        return `
            <div class="pantry-item ${expiryClass}" data-item-id="${item.pantry_item_id}">
                <div class="item-header">
                    <h4 class="item-name">${item.item_name}</h4>
                    <div class="item-actions">
                        <button onclick="editItem(${item.pantry_item_id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteItem(${item.pantry_item_id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="item-details">
                    <p><strong>Quantity:</strong> ${item.quantity} ${item.unit}</p>
                    <p><strong>Storage:</strong> ${item.storage_type}</p>
                    <p><strong>Category:</strong> ${item.category}</p>
                    ${item.expiration_date ? 
                        `<p><strong>Expires:</strong> <span class="expiry-status ${expiryStatus.status}">${expiryStatus.text}</span></p>` : 
                        '<p><strong>Expires:</strong> No expiry date</p>'
                    }
                    <p><strong>Added:</strong> ${new Date(item.date_added).toLocaleDateString()}</p>
                    ${item.notes ? `<p><strong>Notes:</strong> ${item.notes}</p>` : ''}
                </div>
            </div>
        `;
    }
    
    function getExpiryStatus(expirationDate) {
        if (!expirationDate) return { status: 'none', text: 'No expiry date' };
        
        const today = new Date();
        const expiry = new Date(expirationDate);
        const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            const absDays = Math.abs(diffDays);
            if (absDays >= 365) {
                const years = Math.floor(absDays / 365);
                return { status: 'expired', text: `Expired ${years}+ years ago` };
            }
            return { status: 'expired', text: `Expired ${absDays} days ago` };
        } else if (diffDays <= 3) {
            return { status: 'expiring_soon', text: `Expires in ${diffDays} days` };
        } else {
            if (diffDays >= 365) {
                const years = Math.floor(diffDays / 365);
                return { status: 'fresh', text: `Expires in ${years}+ years` };
            }
            return { status: 'fresh', text: `Expires in ${diffDays} days` };
        }
    }
    
    function updateStats(items) {
        const totalItems = items.length;
        let expiredItems = 0;
        let expiringSoonItems = 0;
        
        items.forEach(item => {
            const status = getExpiryStatus(item.expiration_date);
            if (status.status === 'expired') expiredItems++;
            else if (status.status === 'expiring_soon') expiringSoonItems++;
        });
        
        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('expiredItems').textContent = expiredItems;
        document.getElementById('expiringSoonItems').textContent = expiringSoonItems;
    }
    
    async function deleteAllExpiredItems() {
        try {
            // First get all current items to find expired ones
            const response = await fetch('/api/pantry/items');
            const result = await response.json();
            
            if (!result.success) {
                alert('Error fetching pantry items');
                return;
            }
            
            const expiredItems = result.items.filter(item => {
                const status = getExpiryStatus(item.expiration_date);
                return status.status === 'expired';
            });
            
            if (expiredItems.length === 0) {
                alert('No expired items found to delete.');
                return;
            }
            
            const confirmDelete = confirm(`Are you sure you want to delete ${expiredItems.length} expired item(s)? This action cannot be undone.`);
            
            if (!confirmDelete) return;
            
            // Delete each expired item
            let deletedCount = 0;
            for (const item of expiredItems) {
                const deleteResponse = await fetch(`/api/pantry/items/${item.pantry_item_id}`, {
                    method: 'DELETE'
                });
                
                const deleteResult = await deleteResponse.json();
                if (deleteResult.success) {
                    deletedCount++;
                }
            }
            
            if (deletedCount > 0) {
                alert(`Successfully deleted ${deletedCount} expired item(s).`);
                loadPantryItems(); // Refresh the display
            } else {
                alert('Error deleting expired items. Please try again.');
            }
            
        } catch (error) {
            console.error('Delete expired items error:', error);
            alert('Error deleting expired items. Please try again.');
        }
    }
    
    // Global functions for item actions
    window.editItem = async function(itemId) {
        try {
            // Fetch the current item data
            const response = await fetch(`/api/pantry/items/${itemId}`, {
                method: 'GET'
            });
            
            const result = await response.json();
            
            if (result.success && result.item) {
                const item = result.item;
                
                // Populate the edit form
                document.getElementById('editItemId').value = item.pantry_item_id;
                document.getElementById('editItemName').value = item.item_name;
                document.getElementById('editQuantity').value = item.quantity;
                
                // Handle unit selection - check if it's a predefined unit or custom
                const editUnitSelect = document.getElementById('editUnit');
                const editCustomUnitInput = document.getElementById('editCustomUnitInput');
                const predefinedUnits = ['pcs', 'g', 'kg', 'ml', 'l', 'oz', 'lbs'];
                
                if (predefinedUnits.includes(item.unit)) {
                    editUnitSelect.value = item.unit;
                    editCustomUnitInput.style.display = 'none';
                    editCustomUnitInput.required = false;
                    editCustomUnitInput.value = '';
                } else {
                    editUnitSelect.value = 'custom';
                    editCustomUnitInput.style.display = 'block';
                    editCustomUnitInput.required = true;
                    editCustomUnitInput.value = item.unit;
                }
                
                document.getElementById('editStorageType').value = item.storage_type;
                document.getElementById('editCategory').value = item.category;
                document.getElementById('editExpirationDate').value = item.expiration_date || '';
                document.getElementById('editAiPredict').checked = false; // Reset AI prediction
                document.getElementById('editNotes').value = item.notes || '';
                
                // Show the edit modal
                editItemModal.style.display = 'flex';
            } else {
                alert('Error loading item details: ' + (result.message || 'Item not found'));
            }
        } catch (error) {
            console.error('Error loading item for edit:', error);
            alert('Error loading item details. Please try again.');
        }
    };
    
    window.deleteItem = async function(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        try {
            const response = await fetch(`/api/pantry/items/${itemId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                loadPantryItems();
            } else {
                alert('Error deleting item: ' + result.message);
            }
        } catch (error) {
            console.error('Delete item error:', error);
            alert('Error deleting item. Please try again.');
        }
    };
});
</script>
</body>
</html>