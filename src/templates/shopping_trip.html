<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Trip - Preppr</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- QuaggaJS temporarily disabled for UPC testing -->
  
  <style>
    /* CSS Variables matching theme */
    :root {
      --primary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --secondary-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      --accent-gradient: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --error-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #34d399;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --text-white: #ffffff;
      
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      
      --border-light: #e5e7eb;
      --border-medium: #d1d5db;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: var(--font-family);
      color: var(--text-primary);
      line-height: 1.6;
      background: var(--bg-secondary);
      overflow-x: hidden;
    }
    
    /* Header and Navigation */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }
    
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 80px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      text-decoration: none;
      transition: transform 0.3s ease;
    }
    
    .logo:hover {
      transform: scale(1.05);
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--primary-gradient);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }
    
    .nav-links {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
      list-style: none;
    }
    
    .nav-link {
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      position: relative;
      transition: color 0.3s ease;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
    }
    
    .nav-link:hover {
      color: var(--primary-color);
      background: rgba(102, 126, 234, 0.1);
    }
    
    .nav-link.logout {
      background: var(--error-color);
      color: var(--text-white);
    }
    
    .nav-link.logout:hover {
      background: #dc2626;
      color: var(--text-white);
    }

    /* Dropdown Styles */
    .nav-dropdown {
      position: relative;
    }

    .dropdown-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .dropdown-arrow {
      transition: transform 0.3s ease;
    }

    .nav-dropdown:hover .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      min-width: 160px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
      list-style: none;
      padding: var(--spacing-xs) 0;
      margin: 0;
    }

    .dropdown-menu::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 8px;
      height: 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-bottom: none;
      border-right: none;
      transform: translateX(-50%) rotate(45deg);
    }

    .nav-dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .dropdown-link {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      background: none;
      font-size: 0.9rem;
    }

    .dropdown-link:hover {
      background: var(--bg-secondary);
      color: var(--primary-color);
    }

    .dropdown-link.logout {
      color: var(--error-color);
    }

    .dropdown-link.logout:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
    }

    .dropdown-link i {
      font-size: 0.85rem;
      width: 14px;
      text-align: center;
    }

    /* Add subtle separators in dropdown */
    .dropdown-menu li:not(:last-child) {
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dropdown-menu li:last-child .dropdown-link {
      border-bottom: none;
    }

    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--text-primary);
      cursor: pointer;
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }

    .mobile-menu-btn:hover {
      background: var(--bg-secondary);
      color: var(--primary-color);
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
      /* Mobile dropdown adjustments */
      .dropdown-menu {
        position: fixed;
        top: 80px;
        left: var(--spacing-md);
        right: var(--spacing-md);
        min-width: calc(100% - 2 * var(--spacing-md));
        border-radius: var(--radius-xl);
        box-shadow: 
          0 20px 40px rgba(0, 0, 0, 0.15),
          0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-20px) scale(0.95);
        backdrop-filter: blur(20px);
      }
      .dropdown-menu::before {
        display: none;
      }
      .nav-dropdown:hover .dropdown-menu,
      .nav-dropdown.active .dropdown-menu {
        transform: translateY(0) scale(1);
        opacity: 1;
        visibility: visible;
      }
      
      .main-content {
        padding: 100px var(--spacing-md) var(--spacing-lg);
      }
    }
    
    /* Main Content */
    .main-content {
      min-height: 100vh;
      padding: 100px var(--spacing-lg) var(--spacing-xl);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
      animation: fadeInUp 0.8s ease;
    }
    
    .page-title {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }
    
    .page-subtitle {
      font-size: 1.125rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-lg);
    }
    
    /* Start Shopping Section */
    .start-shopping-section {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
      text-align: center;
      animation: fadeInUp 0.8s ease 0.2s both;
    }
    
    .start-shopping-icon {
      width: 80px;
      height: 80px;
      background: var(--primary-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--spacing-lg);
      color: var(--text-white);
      font-size: 2rem;
    }
    
    .start-shopping-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }
    
    .start-shopping-description {
      color: var(--text-secondary);
      font-size: 1.125rem;
      margin-bottom: var(--spacing-xl);
    }
    
    .start-form {
      display: flex;
      gap: var(--spacing-md);
      max-width: 400px;
      margin: 0 auto;
      align-items: end;
    }
    
    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    
    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-input {
      padding: var(--spacing-md);
      border: 2px solid var(--border-light);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-family: var(--font-family);
      transition: all 0.3s ease;
      background: var(--bg-primary);
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: var(--text-white);
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      white-space: nowrap;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Trip Active Section */
    .trip-active {
      animation: fadeInUp 0.8s ease 0.2s both;
    }
    
    .trip-header {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .trip-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
    }
    
    .trip-icon {
      width: 60px;
      height: 60px;
      background: var(--success-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-white);
      font-size: 1.5rem;
    }
    
    .trip-details h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }
    
    .trip-store {
      color: var(--text-secondary);
      font-size: 1.125rem;
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border-medium);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .btn-secondary:hover {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
    }
    
    /* Budget Overview */
    .budget-overview {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
    }
    
    .budget-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    
    .budget-icon {
      width: 50px;
      height: 50px;
      background: var(--warning-gradient);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-white);
      font-size: 1.25rem;
    }
    
    .budget-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .budget-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-lg);
    }
    
    .budget-stat {
      text-align: center;
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
    }
    
    .budget-stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: var(--spacing-xs);
    }
    
    .budget-stat-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Add Item Section */
    .add-item-section {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    
    .section-icon {
      width: 50px;
      height: 50px;
      background: var(--accent-gradient);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-white);
      font-size: 1.25rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .add-item-form {
      display: grid;
      grid-template-columns: 1fr 120px 80px auto;
      gap: var(--spacing-md);
      align-items: end;
    }
    
    /* Cart Items */
    .cart-section {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
    }
    
    .cart-items {
      display: grid;
      gap: var(--spacing-md);
    }
    
    .cart-item {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      border: 1px solid var(--border-light);
      display: grid;
      grid-template-columns: 80px 1fr auto auto auto auto;
      gap: var(--spacing-lg);
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .cart-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .item-image {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-lg);
      object-fit: cover;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 2rem;
    }
    
    .item-details {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    
    .item-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1.125rem;
    }
    
    .item-price {
      color: var(--text-secondary);
      font-size: 1rem;
    }
    
    .item-quantity {
      background: var(--primary-gradient);
      color: var(--text-white);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 600;
      text-align: center;
      min-width: 40px;
    }
    
    .item-subtotal {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--success-color);
    }
    
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      padding: var(--spacing-xs);
      border: 1px solid var(--border-light);
    }
    
    .qty-btn {
      width: 32px;
      height: 32px;
      background: var(--primary-color);
      color: var(--text-white);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .qty-btn:hover {
      background: var(--secondary-color);
      transform: scale(1.05);
    }
    
    .qty-btn:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }
    
    .qty-input {
      width: 50px;
      height: 32px;
      text-align: center;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .qty-input:focus {
      outline: none;
    }
    
    .item-actions {
      display: flex;
      gap: var(--spacing-xs);
    }
    
    .delete-btn {
      width: 36px;
      height: 36px;
      background: var(--error-color);
      color: var(--text-white);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    
    .empty-cart {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
    }
    
    .empty-cart-icon {
      font-size: 4rem;
      color: var(--text-muted);
      margin-bottom: var(--spacing-lg);
    }
    
    .empty-cart-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }
    
    .empty-cart-description {
      font-size: 1rem;
      color: var(--text-secondary);
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn-success {
      background: var(--success-gradient);
      color: var(--text-white);
      border: none;
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--radius-lg);
      font-size: 1.125rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-cancel {
      background: var(--error-gradient);
      color: var(--text-white);
      border: none;
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .btn-cancel:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Loading State */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Impulse Purchase Popup */
    .impulse-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }
    
    .impulse-popup-content {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow-xl);
      animation: slideIn 0.3s ease;
    }
    
    .impulse-icon {
      width: 80px;
      height: 80px;
      background: var(--warning-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--spacing-lg);
      color: var(--text-white);
      font-size: 2rem;
    }
    
    .impulse-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }
    
    .impulse-description {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
      line-height: 1.6;
    }
    
    .impulse-actions {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
    }
    
    .btn-impulse-no {
      background: var(--primary-gradient);
      color: var(--text-white);
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-impulse-yes {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border-medium);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    /* Footer */
    .footer {
      background: var(--text-primary);
      color: var(--text-white);
      padding: var(--spacing-xl) var(--spacing-lg);
      text-align: center;
      margin-top: var(--spacing-2xl);
    }
    
    .footer p {
      color: rgba(255, 255, 255, 0.7);
      margin: 0;
      font-size: 0.875rem;
    }
    
    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }
      
      .main-content {
        padding: 100px var(--spacing-md) var(--spacing-lg);
      }
      
      .start-form {
        flex-direction: column;
        align-items: stretch;
      }
      
      .add-item-form {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }
      
      .cart-item {
        grid-template-columns: 1fr;
        text-align: center;
        gap: var(--spacing-md);
      }
      
      .quantity-controls {
        justify-self: center;
      }
      
      .item-actions {
        justify-self: center;
      }
      
      .budget-stats {
        grid-template-columns: 1fr;
      }
      
      .trip-header {
        flex-direction: column;
        gap: var(--spacing-lg);
        text-align: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
    
    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Barcode scanner styles temporarily removed */

    /* Focus styles for accessibility */
    .btn-primary:focus,
    .btn-secondary:focus,
    .btn-success:focus,
    .btn-cancel:focus,
    .nav-link:focus,
    .form-input:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="nav-container">
      <a href="{{ url_for('shopping.home') }}" class="logo">
        <img src="{{ url_for('static', filename='images/preppr-logo.png') }}" alt="Preppr Logo" style="width: 40px; height: 40px; border-radius: var(--radius-lg);">
        Preppr
      </a>
      
      <nav>
        <ul class="nav-links">
          <li><a href="{{ url_for('shopping.home') }}" class="nav-link">
            <i class="fas fa-home" style="margin-right: 6px; font-size: 0.85em;"></i>Home
          </a></li>
          <li class="nav-dropdown">
            <a href="#" class="nav-link dropdown-toggle">
              <i class="fas fa-shopping-cart" style="margin-right: 6px; font-size: 0.85em;"></i>Shopping
              <i class="fas fa-chevron-down dropdown-arrow" style="margin-left: 6px; font-size: 0.7em;"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a href="{{ url_for('shopping.shopping_trip') }}" class="dropdown-link">
                <i class="fas fa-cart-plus"></i>New Trip
              </a></li>
              <li><a href="{{ url_for('shopping.shopping_lists') }}" class="dropdown-link">
                <i class="fas fa-list-ul"></i>Lists
              </a></li>
            </ul>
          </li>
          <li><a href="{{ url_for('shopping.budget') }}" class="nav-link">
            <i class="fas fa-chart-line" style="margin-right: 6px; font-size: 0.85em;"></i>Budget & Analytics
          </a></li>
          <li class="nav-dropdown">
            <a href="#" class="nav-link dropdown-toggle">
              <i class="fas fa-utensils" style="margin-right: 6px; font-size: 0.85em;"></i>Kitchen
              <i class="fas fa-chevron-down dropdown-arrow" style="margin-left: 6px; font-size: 0.7em;"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a href="{{ url_for('shopping.pantry') }}" class="dropdown-link">
                <i class="fas fa-warehouse"></i>My Pantry
              </a></li>
              <li><a href="{{ url_for('shopping.meal_plans') }}" class="dropdown-link">
                <i class="fas fa-calendar-alt"></i>Meal Plans
              </a></li>
            </ul>
          </li>
          <li class="nav-dropdown">
            <a href="#" class="nav-link dropdown-toggle">
              <i class="fas fa-user" style="margin-right: 6px; font-size: 0.85em;"></i>Account
              <i class="fas fa-chevron-down dropdown-arrow" style="margin-left: 6px; font-size: 0.7em;"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a href="{{ url_for('shopping.rewards') }}" class="dropdown-link">
                <i class="fas fa-trophy"></i>Rewards
              </a></li>
              <li><a href="{{ url_for('auth.logout') }}" class="dropdown-link logout">
                <i class="fas fa-sign-out-alt"></i>Logout
              </a></li>
            </ul>
          </li>
        </ul>
        
        <button class="mobile-menu-btn" aria-label="Toggle mobile menu">
          <i class="fas fa-bars"></i>
        </button>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      {% if not cart_session %}
      <!-- No Active Shopping Trip -->
      <section class="page-header">
        <h1 class="page-title">Start Shopping Trip</h1>
        <p class="page-subtitle">Begin your smart shopping experience with AI-powered recommendations</p>
      </section>

      <section class="start-shopping-section">
        <div class="start-shopping-icon">
          <i class="fas fa-shopping-bag" aria-hidden="true"></i>
        </div>
        <h2 class="start-shopping-title">Ready to Shop Smart?</h2>
        <p class="start-shopping-description">
          Start a new shopping trip and get personalized recommendations to help you make healthier choices and stay within budget.
        </p>
        
        <form action="{{ url_for('shopping.start_shopping') }}" method="POST" class="start-form">
          <div class="form-group">
            <label for="storeName" class="form-label">Store Name</label>
            <input
              type="text"
              id="storeName"
              name="storeName"
              class="form-input"
              placeholder="e.g., Walmart, Target, Costco"
              required
            />
          </div>
          <button type="submit" class="btn-primary">
            <i class="fas fa-play" aria-hidden="true"></i>
            Start Shopping
          </button>
        </form>
      </section>

      {% else %}
      <!-- Active Shopping Trip -->
      <section class="trip-active">
        <div class="trip-header">
          <div class="trip-info">
            <div class="trip-icon">
              <i class="fas fa-shopping-cart" aria-hidden="true"></i>
            </div>
            <div class="trip-details">
              <h2>Active Shopping Trip</h2>
              <p class="trip-store">{{ cart_session['store_name'] }}</p>
            </div>
          </div>
          <a href="{{ url_for('shopping.home') }}" class="btn-secondary">
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
            Back to Home
          </a>
        </div>

        <!-- Budget Overview -->
        <div class="budget-overview">
          <div class="budget-header">
            <div class="budget-icon">
              <i class="fas fa-wallet" aria-hidden="true"></i>
            </div>
            <h3 class="budget-title">Budget Overview</h3>
          </div>
          <div class="budget-stats" id="budget-overview">
            <div class="budget-stat">
              <div class="budget-stat-value">${{ allocated_budget }}</div>
              <div class="budget-stat-label">Allocated Budget</div>
            </div>
            <div class="budget-stat">
              <div class="budget-stat-value">${{ total_spent or 0 }}</div>
              <div class="budget-stat-label">Total Spent</div>
            </div>
            <div class="budget-stat">
              <div class="budget-stat-value">{{ total_items or 0 }}</div>
              <div class="budget-stat-label">Items in Cart</div>
            </div>
            <div class="budget-stat">
              <div class="budget-stat-value">${{ remaining }}</div>
              <div class="budget-stat-label">Remaining</div>
            </div>
          </div>
        </div>

        <!-- Add Item Section -->
        <div class="add-item-section">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-plus" aria-hidden="true"></i>
            </div>
            <h3 class="section-title">Add Item to Cart</h3>
          </div>
          
          <form id="addItemForm" class="add-item-form">
            <div class="form-group">
              <label for="itemName" class="form-label">Product UPC Code</label>
              <input
                type="text"
                id="itemName"
                name="itemName"
                class="form-input"
                placeholder="Enter UPC code (e.g., 028400064057)"
                required
              />
            </div>
            
            <div class="form-group">
              <label for="itemPrice" class="form-label">Price ($)</label>
              <input
                type="number"
                step="0.01"
                min="0"
                max="999999.99"
                id="itemPrice"
                name="itemPrice"
                class="form-input"
                placeholder="0.00"
                required
              />
            </div>
            
            <div class="form-group">
              <label for="itemQty" class="form-label">Quantity</label>
              <input
                type="number"
                id="itemQty"
                name="itemQty"
                class="form-input"
                min="1"
                value="1"
                required
              />
            </div>
            
            <button type="submit" class="btn-primary">
              <i class="fas fa-cart-plus" aria-hidden="true"></i>
              Add to Cart
            </button>
          </form>
        </div>

        <!-- Cart Items -->
        <div class="cart-section">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-shopping-basket" aria-hidden="true"></i>
            </div>
            <h3 class="section-title">Cart Items</h3>
          </div>
          
          <div class="cart-items" id="cart-items-container">
            {% if cart_items %}
              {% for item in cart_items %}
              <div class="cart-item" data-item-id="{{ item.item_ID }}">
                <div class="item-image">
                  {% if item.image_url %}
                  <img src="{{ item.image_url }}" alt="{{ item.item_name }}" class="item-image">
                  {% else %}
                  <i class="fas fa-image" aria-hidden="true"></i>
                  {% endif %}
                </div>
                <div class="item-details">
                  <div class="item-name">{{ item.item_name }}</div>
                  <div class="item-price">${{ "%.2f"|format(item.price) }} each</div>
                </div>
                <div class="quantity-controls">
                  <button class="qty-btn qty-decrease" data-item-id="{{ item.item_ID }}" data-action="decrease" {% if item.quantity <= 1 %}disabled{% endif %}>
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" class="qty-input" value="{{ item.quantity }}" min="1" max="999" 
                         data-item-id="{{ item.item_ID }}" 
                         onblur="this.value = Math.max(1, parseInt(this.value) || 1)">
                  <button class="qty-btn qty-increase" data-item-id="{{ item.item_ID }}" data-action="increase">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <div class="item-subtotal">${{ "%.2f"|format(item.price * item.quantity) }}</div>
                <div class="item-actions">
                  <button class="delete-btn" data-item-id="{{ item.item_ID }}" title="Remove item">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              {% endfor %}
            {% else %}
            <div class="empty-cart">
              <div class="empty-cart-icon">
                <i class="fas fa-shopping-cart" aria-hidden="true"></i>
              </div>
              <h4 class="empty-cart-title">Your cart is empty</h4>
              <p class="empty-cart-description">Start adding items to see them here</p>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <form action="{{ url_for('shopping.finish_shopping') }}" method="POST" style="display: inline;">
            <button type="submit" class="btn-success">
              <i class="fas fa-check" aria-hidden="true"></i>
              Complete Shopping
            </button>
          </form>
          
          <form action="{{ url_for('shopping.cancel_shopping') }}" method="POST" style="display: inline;">
            <button type="submit" class="btn-cancel" onclick="return confirm('Are you sure you want to cancel this shopping trip? All items will be removed.')">
              <i class="fas fa-times" aria-hidden="true"></i>
              Cancel Trip
            </button>
          </form>
        </div>
      </section>
      {% endif %}
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 Preppr. All rights reserved. Prep smarter. Save time. Eat better.</p>
  </footer>

  <script>
    // Template variables
    const ALLOCATED_BUDGET = JSON.parse('{{ allocated_budget | default(1000) | tojson }}');
    const REMAINING_BUDGET = JSON.parse('{{ remaining | default(1000) | tojson }}');
    const CART_SESSION_EXISTS = JSON.parse('{{ cart_session | default(false) | tojson }}');
    
    // Removed barcode scanner for testing UPC input
    
    // Initialize when DOM is ready
    document.addEventListener("DOMContentLoaded", function () {
      if (CART_SESSION_EXISTS) {
        loadCartItems();
      }
      
      const form = document.getElementById("addItemForm");
      if (form) {
        form.addEventListener("submit", handleFormSubmit);
      }
      
      // Setup cart controls event listeners
      setupCartEventListeners();
    });

    // Load cart items from API
    async function loadCartItems() {
      try {
        const response = await fetch("{{ url_for('shopping_trip.get_cart_items') }}", {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        });
        const data = await response.json();
        
        if (data.items) {
          updateCartDOM(data.items);
        }
        
        // Update budget if available
        if (data.total_items !== undefined) {
          const defaultBudget = JSON.parse('{{ allocated_budget or 1000 }}');
          const defaultRemaining = JSON.parse('{{ remaining or 1000 }}');
          updateBudgetOverview(
            data.allocated_budget || defaultBudget,
            data.total_spent || 0,
            data.total_items || 0,
            data.remaining || defaultRemaining
          );
        }
      } catch (err) {
        console.error("Error loading cart items:", err);
      }
    }

    // Update cart items in DOM
    function updateCartDOM(items) {
      const container = document.getElementById("cart-items-container");
      if (!container) return;

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <div class="empty-cart-icon">
              <i class="fas fa-shopping-cart" aria-hidden="true"></i>
            </div>
            <h4 class="empty-cart-title">Your cart is empty</h4>
            <p class="empty-cart-description">Start adding items to see them here</p>
          </div>
        `;
        return;
      }

      container.innerHTML = items.map(item => {
        const subtotal = (item.price * item.quantity).toFixed(2);
        const imgHtml = item.image_url
          ? `<img src="${item.image_url}" alt="${item.item_name}" class="item-image">`
          : `<div class="item-image"><i class="fas fa-image" aria-hidden="true"></i></div>`;

        return `
          <div class="cart-item" data-item-id="${item.item_ID}">
            ${imgHtml}
            <div class="item-details">
              <div class="item-name">${escapeHtml(item.item_name)}</div>
              <div class="item-price">$${parseFloat(item.price).toFixed(2)} each</div>
            </div>
            <div class="quantity-controls">
              <button class="qty-btn qty-decrease" data-item-id="${item.item_ID}" data-action="decrease" ${item.quantity <= 1 ? 'disabled' : ''}>
                <i class="fas fa-minus"></i>
              </button>
              <input type="number" class="qty-input" value="${item.quantity}" min="1" max="999" 
                     data-item-id="${item.item_ID}" 
                     onblur="this.value = Math.max(1, parseInt(this.value) || 1)">
              <button class="qty-btn qty-increase" data-item-id="${item.item_ID}" data-action="increase">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="item-subtotal">$${subtotal}</div>
            <div class="item-actions">
              <button class="delete-btn" data-item-id="${item.item_ID}" title="Remove item">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update budget overview
    function updateBudgetOverview(allocated, spent, totalItems, remaining) {
      const budgetEl = document.getElementById("budget-overview");
      if (budgetEl) {
        budgetEl.innerHTML = `
          <div class="budget-stat">
            <div class="budget-stat-value">$${allocated}</div>
            <div class="budget-stat-label">Allocated Budget</div>
          </div>
          <div class="budget-stat">
            <div class="budget-stat-value">$${spent}</div>
            <div class="budget-stat-label">Total Spent</div>
          </div>
          <div class="budget-stat">
            <div class="budget-stat-value">${totalItems}</div>
            <div class="budget-stat-label">Items in Cart</div>
          </div>
          <div class="budget-stat">
            <div class="budget-stat-value">$${remaining}</div>
            <div class="budget-stat-label">Remaining</div>
          </div>
        `;
      }
    }

    // Handle form submission
    async function handleFormSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Add loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        submitBtn.disabled = true;
        form.classList.add('loading');

        const itemName = document.getElementById("itemName").value.trim();
        const itemPrice = parseFloat(document.getElementById("itemPrice").value);
        const itemQty = parseInt(document.getElementById("itemQty").value, 10);

        if (!itemName || isNaN(itemPrice) || isNaN(itemQty) || itemQty <= 0) {
            alert("Please enter valid item details.");
            resetForm();
            return;
        }

        try {
            // Show processing message
            showNotification(`üîç Looking up UPC: ${itemName}...`, 'info');
            
            // 1) Search for item by UPC using Nutritionix API
            const searchResponse = await fetch(`{{ url_for('shopping_trip.searchitem') }}?upc=${encodeURIComponent(itemName)}`);
            const searchData = await searchResponse.json();

            // 2) Extract food data with improved fallback handling
            let brandName = "Unknown Brand";
            let foodName = "Unknown Item";
            let imageUrl = "https://t4.ftcdn.net/jpg/02/51/95/53/360_F_251955356_FAQH0U1y1TZw3ZcdPGybwUkH90a3VAhb.jpg";
            let carbs = 0, sugar = 0, sodium = 0, fat = 0;

            console.log('Nutritionix API Response:', searchData);

            // Check if we found data in Nutritionix API
            if (searchData.foods && searchData.foods.length > 0) {
                const firstItem = searchData.foods[0];
                brandName = firstItem.brand_name || brandName;
                foodName = firstItem.food_name || foodName;
                imageUrl = firstItem.photo?.thumb || imageUrl;
                carbs = firstItem.nf_total_carbohydrate || 0;
                sugar = firstItem.nf_sugars || 0;
                sodium = firstItem.nf_sodium || 0;
                fat = firstItem.nf_saturated_fat || 0;
                
                // Show success message if found
                console.log('Product found in Nutritionix database:', searchData.message);
                showNotification(`‚úÖ Found: ${brandName} - ${foodName}`, 'success');
            } else if (searchData.fallback) {
                // Use fallback data if API failed or item not found
                const fallbackItem = searchData.fallback;
                brandName = fallbackItem.brand_name || brandName;
                foodName = fallbackItem.food_name || foodName;
                imageUrl = fallbackItem.photo?.thumb || imageUrl;
                carbs = fallbackItem.nf_total_carbohydrate || 0;
                sugar = fallbackItem.nf_sugars || 0;
                sodium = fallbackItem.nf_sodium || 0;
                fat = fallbackItem.nf_saturated_fat || 0;
                
                // Show warning about fallback data
                console.warn('Using fallback data:', searchData.message || searchData.error);
                showNotification('‚ö†Ô∏è Product not found in database. Using generic data.', 'warning');
            } else {
                // Last resort - completely manual entry
                foodName = `Manual Entry (${itemName})`;
                console.warn('No product data available, using manual entry');
                showNotification('‚ö†Ô∏è No product data available. Adding as manual entry.', 'warning');
            }

            const combinedName = `${brandName} - ${foodName}`;

            // 3) Add item to cart
            const addItemResponse = await fetch("{{ url_for('shopping_trip.add_item') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    upc: itemName,
                    price: itemPrice,
                    quantity: itemQty,
                    itemName: combinedName,
                    imageUrl: imageUrl
                })
            });

            const resultData = await addItemResponse.json();

            if (addItemResponse.ok && resultData.items) {
                updateCartDOM(resultData.items);
                
                // Update budget
                const totalSpent = resultData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const totalItems = resultData.items.reduce((sum, item) => sum + item.quantity, 0);
                const allocatedBudget = JSON.parse('{{ allocated_budget or 1000 }}');
                updateBudgetOverview(allocatedBudget, totalSpent, totalItems, allocatedBudget - totalSpent);
                
                showNotification(`‚úÖ Added to cart: ${combinedName}`, 'success');
            } else {
                showNotification(`‚ùå Failed to add item: ${resultData.error || 'Unknown error'}`, 'error');
            }

            // 4) Check for impulse purchase if we have nutritional data
            if (carbs > 0 || sugar > 0 || sodium > 0 || fat > 0) {
                try {
                    const predictResponse = await fetch(`{{ url_for('shopping_trip.predict') }}?carbs=${carbs}&sugar=${sugar}&sodium=${sodium}&fat=${fat}`);
                    const predictData = await predictResponse.json();

                    if (predictData.prediction == 1) {
                        showImpulsePopup(carbs, sugar, sodium, fat);
                    }
                } catch (predictError) {
                    console.warn('Impulse prediction failed:', predictError);
                }
            }

            // Clear form
            form.reset();
            
        } catch (err) {
            console.error("Error adding item:", err);
            showNotification(`‚ùå Error: ${err.message}`, 'error');
        } finally {
            resetForm();
        }

        function resetForm() {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            form.classList.remove('loading');
        }
    }

    // Show impulse purchase popup
    function showImpulsePopup(carbs, sugar, sodium, fat) {
      const popup = document.createElement('div');
      popup.className = 'impulse-popup';
      popup.innerHTML = `
        <div class="impulse-popup-content">
          <div class="impulse-icon">
            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
          </div>
          <h3 class="impulse-title">Impulse Purchase Detected!</h3>
          <p class="impulse-description">
            Our AI detected this might be an impulse purchase based on the nutritional content. 
            Are you sure you want to keep this item?
          </p>
          <div class="impulse-actions">
            <button class="btn-impulse-no" onclick="handleImpulseResponse(false, ${carbs}, ${sugar}, ${sodium}, ${fat})">
              Keep It
            </button>
            <button class="btn-impulse-yes" onclick="handleImpulseResponse(true, ${carbs}, ${sugar}, ${sodium}, ${fat})">
              Remove It
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(popup);

      // Remove on outside click
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          document.body.removeChild(popup);
        }
      });
    }

    // Handle impulse purchase response
    async function handleImpulseResponse(wasImpulse, carbs, sugar, sodium, fat) {
      const popup = document.querySelector('.impulse-popup');
      if (popup) {
        document.body.removeChild(popup);
      }

      // Send feedback to ML model
      const label = wasImpulse ? 1 : 0;
      fetch(`{{ url_for('shopping_trip.learn') }}?carbs=${carbs}&sugar=${sugar}&sodium=${sodium}&fat=${fat}&label=${label}`)
        .catch(error => console.error("ML feedback failed:", error));

      if (wasImpulse) {
        // Remove the last added item
        try {
          const response = await fetch("/api/shopping-trip/remove-last-item", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          
          const data = await response.json();
          if (data.items) {
            updateCartDOM(data.items);
            
            // Update budget
            const totalSpent = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalItems = data.items.reduce((sum, item) => sum + item.quantity, 0);
            const allocatedBudget = JSON.parse('{{ allocated_budget or 1000 }}');
            updateBudgetOverview(allocatedBudget, totalSpent, totalItems, allocatedBudget - totalSpent);
          }
        } catch (error) {
          console.error("Error removing item:", error);
        }
      }
    }

    // Update item quantity
    async function updateQuantity(itemId, newQuantity) {
      try {
        newQuantity = Math.max(1, parseInt(newQuantity) || 1);
        
        const response = await fetch('/api/shopping-trip/update-item', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            item_id: itemId,
            quantity: newQuantity
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          updateCartDOM(data.items);
          updateBudgetOverview(
            data.allocated_budget,
            data.total_spent,
            data.total_items,
            data.remaining
          );
        } else {
          const errorData = await response.json();
          console.error('Failed to update quantity:', errorData.error);
          alert('Failed to update item quantity. Please try again.');
        }
      } catch (error) {
        console.error('Error updating quantity:', error);
        alert('An error occurred while updating the quantity. Please try again.');
      }
    }
    
    // Update quantity from input field
    function updateQuantityFromInput(input) {
      const itemId = parseInt(input.dataset.itemId);
      const newQuantity = parseInt(input.value);
      updateQuantity(itemId, newQuantity);
    }
    
    // Setup event listeners for cart controls
    function setupCartEventListeners() {
      document.addEventListener('click', function(e) {
        // Handle quantity buttons
        if (e.target.closest('.qty-btn')) {
          const button = e.target.closest('.qty-btn');
          const itemId = parseInt(button.dataset.itemId);
          const action = button.dataset.action;
          
          if (action === 'increase') {
            const currentQty = parseInt(button.parentElement.querySelector('.qty-input').value);
            updateQuantity(itemId, currentQty + 1);
          } else if (action === 'decrease') {
            const currentQty = parseInt(button.parentElement.querySelector('.qty-input').value);
            updateQuantity(itemId, currentQty - 1);
          }
        }
        
        // Handle delete buttons
        if (e.target.closest('.delete-btn')) {
          const button = e.target.closest('.delete-btn');
          const itemId = parseInt(button.dataset.itemId);
          deleteItem(itemId);
        }
      });
      
      // Handle quantity input changes
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('qty-input')) {
          updateQuantityFromInput(e.target);
        }
      });
    }
    
    // Delete an item from cart
    async function deleteItem(itemId) {
      if (!confirm('Are you sure you want to remove this item from your cart?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/shopping-trip/delete-item', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            item_id: itemId
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          updateCartDOM(data.items);
          updateBudgetOverview(
            data.allocated_budget,
            data.total_spent,
            data.total_items,
            data.remaining
          );
        } else {
          const errorData = await response.json();
          console.error('Failed to delete item:', errorData.error);
          alert('Failed to remove item. Please try again.');
        }
      } catch (error) {
        console.error('Error deleting item:', error);
        alert('An error occurred while removing the item. Please try again.');
      }
    }

    // Barcode scanner functions temporarily disabled for UPC testing

    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : type === 'warning' ? 'var(--warning-color)' : 'var(--primary-color)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        animation: fadeInUp 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000); // Show warning messages a bit longer
    }

    // Utility function
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize dropdown functionality
    function initializeDropdowns() {
      // Get all dropdown toggles
      const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
      
      dropdownToggles.forEach(toggle => {
        // Handle mobile click behavior
        if (window.innerWidth <= 768) {
          toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const dropdown = this.closest('.nav-dropdown');
            const menu = dropdown.querySelector('.dropdown-menu');
            
            // Close other dropdowns
            document.querySelectorAll('.nav-dropdown').forEach(otherDropdown => {
              if (otherDropdown !== dropdown) {
                otherDropdown.classList.remove('active');
              }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('active');
          });
        }
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.nav-dropdown')) {
          document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        }
      });
    }

    // Handle window resize for dropdown behavior
    function handleDropdownResize() {
      window.addEventListener('resize', function() {
        // Remove active class when switching to desktop
        if (window.innerWidth > 768) {
          document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        }
      });
    }

    // Initialize dropdowns when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initializeDropdowns();
      handleDropdownResize();
    });
  </script>
</body>
</html>